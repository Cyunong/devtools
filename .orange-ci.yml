
feature/remote-debug:
  review:
    - stages:
      - name: CR 通过后自动合并
        type: git:automerge
        options:
          mergeType: rebase
          removeSourceBranch: true
          ignoreAssignee: true
        exports:
          reviewedBy: REVIEWED_BY
      - name: notify
        type: wework:message
        options:
          robot: 25dcf80a-ff7c-422c-9b5b-1951cee42f4c
          chatId: wrkSFfCgAAjWlVtrYwk5xNzuRwijAv_Q
          visibleToUser: ${ORANGE_BUILD_USER}
          message: |
            > CR 通过后自动合并 <@${ORANGE_BUILD_USER}>
            > 　
            > ${ORANGE_MERGE_REQUEST_TITLE}
            > [${ORANGE_EVENT_URL}](${ORANGE_EVENT_URL})
            >
            > ${REVIEWED_BY}
  merge_request:
    - name: MR流水线
      runner:
        network: devnet
      stages:
        # 提交注释检查
        - name: commit lint
          type: epc:commit-lint
        - name: 代码安全审计
          type: security:code-scan
          options:
            sourcePath: src
            ignoreFolder: src/public
        # 代码规范检查
        - name: eslint-config-tencent
          script: "tnpm install && tnpm run lint"
        # 发送到 CR 专用群
        - name: notify
          type: wework:message
          options:
            robot: 25dcf80a-ff7c-422c-9b5b-1951cee42f4c
            message: |
              > 发送到 CR 专用群
              > 　
              > ${ORANGE_MERGE_REQUEST_TITLE}
              > [${ORANGE_EVENT_URL}](${ORANGE_EVENT_URL})
              > 　
              > from ${ORANGE_BUILD_USER}
  push:
    - name: push流水线
      wework:
        title: "publish devtools-debug-server"
      runner:
        network: devnet
      # ifModify:
      #   - src/**
      stages:
        - name: npm i
          script: npm install --registry=https://mirrors.tencent.com/npm/
        - name: set npm orign
          script: npm config set registry https://registry.npmjs.org
        - name: build
          script: npm run build
        - name: patch version
          script: npm version patch
        - name: npm publish
          image: plugins/npm
          envFrom: https://git.woa.com/gcd/social-private-key/blob/master/tdf-devtools/npm-token.yml
          settings:
            token: $NPM_TOKEN
            email: $EMAIL
            fail_on_version_conflict: true
        - name: commit change
          type: git:commit
          options:
            commitMessage: 'version: publish new version'
        - name: push version
          script: git push
        # - name: notify npm publish
        #   type: wework:message
        #   options:
        #     robot: 25dcf80a-ff7c-422c-9b5b-1951cee42f4c
        #     message: |
        #       > npm 包已发布
        #       > 　
        #       > published by ${ORANGE_BUILD_USER}

